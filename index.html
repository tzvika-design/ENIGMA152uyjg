<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ENIGMA â€“ Laboratory Manager v6.0</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAABhUlEQVRYhe2XsU7DMBCGv0gMiIWBgQEJiYGFhYkn4AF4AJ6AZ2BhYWFgYGBgYGBgQEJiYGFhYGAA8QCMdJJxnThxYqdS+0mWZNu5+3N3vvgMGzZs+K8xAk6BZ+AbeBrLrCpCWRE7ALdAM0ReF+UywB1wLu7dAo1QoSbwFHgFroAjcRkiTQI8AE/AJbAvLl8VYSJhPQbugedx2C/Awdj9HXAK3I/fL4E9YAe4Bq6BO+BWlH0E9sVzW8AdcCPKPgNHwCGwA1wBV8A1cAvci7LPwBFwIOZnA9fAJXAHPIiyL8CRmN8WcA1ciPm9A6fAIbANXAAXwA3wIMq+AkfAgShzAlwA58ADcCrKvgFHYn4bcA6ci/k9AqfAIbAFnAPnwA3wKMq+A0dibhtwBpyJ+T0Bp8AhsAWcAWfADfAkyr4DR2JuG3AKnIr5PQOnwCGwBZwCp8AN8CzKvgNHYm4bcAKciPm9AGfAIbAJnAAn4/d34Aw4A86BF1H2HTgSc/8B/gH8b0ChWYgAAAAASUVORK5CYII=">
  <style>
    :root {
      --bg: #1a1510;
      --panel: rgba(30, 25, 20, 0.95);
      --panel2: rgba(40, 35, 28, 0.9);
      --text: #f5f0e8;
      --muted: #a09080;
      --accent: #d4a853;
      --accent-light: #f0d78c;
      --gold: #c9a227;
      --gold-light: #e8d48b;
      --success: #7cb342;
      --danger: #d84315;
      --line: rgba(212,168,83,0.15);
      --chip: rgba(212,168,83,0.2);
      --glow: 0 0 30px rgba(212,168,83,0.4);
      color-scheme: dark;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* Hide scrollbar flicker */
    html {
      overflow-y: scroll;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gold-light);
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: 
        radial-gradient(ellipse 120% 80% at 0% 0%, rgba(201,162,39,0.15), transparent 50%),
        radial-gradient(ellipse 100% 60% at 100% 100%, rgba(139,195,74,0.08), transparent 50%),
        radial-gradient(ellipse 80% 50% at 50% 0%, rgba(212,168,83,0.1), transparent),
        linear-gradient(180deg, #1a1510 0%, #0f0d0a 50%, #1a1510 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--text);
      line-height: 1.5;
    }

    /* Decorative side gradients */
    body::before,
    body::after {
      content: '';
      position: fixed;
      top: 0;
      bottom: 0;
      width: 150px;
      pointer-events: none;
      z-index: 0;
    }
    
    body::before {
      left: 0;
      background: linear-gradient(90deg, rgba(201,162,39,0.08), transparent);
    }
    
    body::after {
      right: 0;
      background: linear-gradient(-90deg, rgba(139,195,74,0.05), transparent);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 24px 60px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 16px 24px;
      margin-bottom: 24px;
      background: linear-gradient(135deg, rgba(30,25,20,0.98), rgba(40,35,28,0.95));
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--glow), 0 4px 20px rgba(0,0,0,0.3);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-logo {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      border: 2px solid var(--accent);
      box-shadow: var(--glow);
      background: linear-gradient(135deg, #2a2520, #1a1510);
      padding: 4px;
    }

    .brand h1 {
      font-size: 2rem;
      font-weight: 300;
      color: var(--accent);
      letter-spacing: 8px;
      text-shadow: 0 0 40px rgba(212,168,83,0.6);
      font-family: 'Times New Roman', serif;
    }

    .brand p {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 2px;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .sync-indicator {
      font-size: 1.2rem;
      padding: 8px;
      border-radius: 8px;
      cursor: help;
      transition: all 0.3s;
    }
    
    .sync-indicator.syncing {
      animation: spin 1s linear infinite;
    }
    
    .sync-indicator.synced {
      color: var(--success);
    }
    
    .sync-indicator.error {
      color: var(--danger);
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Buttons */
    .btn {
      padding: 10px 18px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover { background: rgba(255,255,255,0.08); }
    .btn:active { transform: scale(0.98); }

    .btn.primary {
      background: rgba(212,168,83,0.2);
      border-color: rgba(212,168,83,0.4);
      color: var(--accent-light);
    }

    .btn.success {
      background: rgba(34,197,94,0.15);
      border-color: rgba(34,197,94,0.35);
      color: #4ade80;
    }

    .btn.danger {
      background: rgba(239,68,68,0.12);
      border-color: rgba(239,68,68,0.3);
      color: #f87171;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .tab {
      padding: 12px 20px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      border-radius: 999px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    .tab:hover { border-color: rgba(212,168,83,0.3); }

    .tab.active {
      border-color: rgba(212,168,83,0.5);
      background: rgba(212,168,83,0.12);
      color: var(--accent-light);
    }

    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }

    /* Cards */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    }

    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 16px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Forms */
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 150px;
      flex: 1;
    }

    label {
      font-size: 0.8rem;
      color: var(--muted);
      font-weight: 600;
    }

    input, select, textarea {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
    }

    textarea { min-height: 100px; resize: vertical; }

    select {
      background: rgba(18,22,31,0.95) !important;
      cursor: pointer;
    }

    select option {
      background: #12161f;
      color: var(--text);
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .row.between { justify-content: space-between; }

    /* Chips & Pills */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--chip);
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--accent-light);
    }

    .pill {
      padding: 6px 12px;
      border: 1px solid var(--line);
      border-radius: 999px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    /* Stats */
    .stats {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin: 16px 0;
    }

    .stat {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px 16px;
      min-width: 140px;
    }

    .stat .k {
      font-size: 0.75rem;
      color: var(--muted);
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat .v {
      font-size: 1.3rem;
      font-weight: 800;
    }

    /* Progress Bar */
    .bar {
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      overflow: hidden;
      border: 1px solid var(--line);
      margin-top: 6px;
    }

    .bar > div {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      transition: width 0.3s;
    }

    .bar.over > div {
      background: linear-gradient(90deg, var(--danger), #f97316);
    }

    /* Tables */
    .table-wrap {
      overflow-x: auto;
      margin-top: 16px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }

    th {
      text-align: right;
      font-size: 0.8rem;
      color: var(--muted);
      font-weight: 700;
      padding: 8px 12px;
    }

    .tr {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
    }

    .tr td {
      padding: 12px;
      border-top: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
    }

    .tr td:first-child {
      border-right: 1px solid var(--line);
      border-top-right-radius: 12px;
      border-bottom-right-radius: 12px;
    }

    .tr td:last-child {
      border-left: 1px solid var(--line);
      border-top-left-radius: 12px;
      border-bottom-left-radius: 12px;
    }

    /* Toggles */
    .toggles {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .toggle-btn {
      padding: 8px 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .toggle-btn.on {
      background: rgba(34,197,94,0.15);
      border-color: rgba(34,197,94,0.35);
      color: #4ade80;
    }

    /* Hr */
    .hr {
      height: 1px;
      background: var(--line);
      margin: 16px 0;
    }

    /* Text helpers */
    .muted { color: var(--muted); }
    .mono { font-family: ui-monospace, 'SF Mono', monospace; }
    .small { font-size: 0.8rem; color: var(--muted); }
    .warn { color: var(--danger); font-weight: 700; }
    .ok { color: var(--success); font-weight: 700; }
    .hidden { display: none !important; }

    /* Modals */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }

    .overlay.show { display: flex; }

    .modal {
      width: min(900px, 100%);
      max-height: 90vh;
      overflow: auto;
      background: linear-gradient(180deg, rgba(18,22,31,0.98), rgba(10,13,20,0.98));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.5);
      padding: 20px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 16px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--line);
    }

    .modal-header h3 {
      font-size: 1.2rem;
      color: var(--accent);
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 8px;
    }

    .close-btn:hover { background: rgba(255,255,255,0.1); }

    /* Full Page View */
    .fullpage {
      position: fixed;
      inset: 0;
      background: rgba(10,13,20,0.98);
      backdrop-filter: blur(8px);
      display: none;
      flex-direction: column;
      z-index: 2000;
      overflow: hidden;
    }

    .fullpage.show { display: flex; }

    .fullpage-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: rgba(18,22,31,0.9);
      border-bottom: 1px solid var(--line);
    }

    .fullpage-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Category sections in formula */
    .cat-section {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .cat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .cat-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px dashed var(--line);
    }

    .cat-row:last-child { border-bottom: none; }

    .cat-row .name { flex: 2; font-weight: 600; min-width: 180px; }
    .cat-row .ml-col { width: 100px; }
    .cat-row .pct-col { width: 80px; text-align: center; }
    .cat-row .cost-col { width: 100px; text-align: left; }
    .cat-row .action-col { width: 80px; }

    /* Section title */
    .section-title {
      font-size: 0.95rem;
      color: var(--muted);
      font-weight: 800;
      margin: 20px 0 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container { padding: 12px; }
      header { flex-direction: column; text-align: center; }
      .brand h1 { font-size: 1.5rem; }
      .tabs { justify-content: center; }
      .tab { flex: 1; text-align: center; min-width: 80px; padding: 10px; font-size: 0.85rem; }
      .modal { padding: 16px; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <svg class="brand-logo" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="dropGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#d4a853"/>
              <stop offset="100%" style="stop-color:#8b7355"/>
            </linearGradient>
          </defs>
          <path d="M32 4C32 4 16 24 16 40C16 48.8 23.2 56 32 56C40.8 56 48 48.8 48 40C48 24 32 4 32 4Z" 
                stroke="url(#dropGrad)" stroke-width="2" fill="none"/>
          <path d="M32 16C32 16 24 28 24 36C24 40.4 27.6 44 32 44C36.4 44 40 40.4 40 36C40 28 32 16 32 16Z" 
                stroke="url(#dropGrad)" stroke-width="1.5" fill="none" opacity="0.6"/>
          <ellipse cx="32" cy="52" rx="4" ry="2" stroke="url(#dropGrad)" stroke-width="1.5" fill="none"/>
        </svg>
        <div>
          <h1>ENIGMA</h1>
          <p>Mystery in Every Drop</p>
        </div>
      </div>
      <div class="header-actions">
        <span id="syncIndicator" class="sync-indicator" title="××¦×‘ ×¡× ×›×¨×•×Ÿ">ğŸ’¾</span>
        <button class="btn" id="btnExport">ğŸ“¤ ×™×™×¦×•×</button>
        <button class="btn" id="btnImport">ğŸ“¥ ×™×™×‘×•×</button>
        <button class="btn" id="btnSync">ğŸ”„ ×¡× ×›×¨×Ÿ</button>
        <button class="btn danger" id="btnReset">ğŸ—‘ï¸ ××™×¤×•×¡</button>
      </div>
    </header>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="materials">ğŸ“¦ ×—×•××¨×™ ×’×œ×</div>
      <div class="tab" data-tab="dev">ğŸ§ª ×¤×™×ª×•×—×™×</div>
      <div class="tab" data-tab="final">âœ¨ ×‘×©××™× ×¡×•×¤×™×™×</div>
      <div class="tab" data-tab="pricing">ğŸ’° ×ª××—×•×¨</div>
      <div class="tab" data-tab="settings">âš™ï¸ ×”×’×“×¨×•×ª</div>
    </div>

    <div class="grid">
      <div class="card" id="leftPanel"></div>
      <div class="card" id="rightPanel"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">×—×œ×•×Ÿ</h3>
        <button class="close-btn" id="modalClose">Ã—</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Full Page View -->
  <div class="fullpage" id="fullpage">
    <div class="fullpage-header">
      <button class="btn" id="fpClose">âœ• ×¡×’×•×¨</button>
      <h3 id="fpTitle">×¦×¤×™×™×”</h3>
      <div class="pill" id="fpPill"></div>
    </div>
    <div class="fullpage-body" id="fpBody"></div>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="importFile" accept="application/json" style="display:none">

<script>
(() => {
  "use strict";

  // Utilities
  const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36);
  const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
  const num = (v, d = 0) => {
    const n = Number(String(v).replace(",", "."));
    return Number.isFinite(n) ? n : d;
  };
  const fmt = (n, d = 2) => {
    const rounded = Math.round((num(n, 0) + Number.EPSILON) * Math.pow(10, d)) / Math.pow(10, d);
    return rounded.toLocaleString("he-IL", { maximumFractionDigits: d });
  };
  const todayISO = () => new Date().toISOString().slice(0, 10);
  const escapeHtml = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");

  // Categories
  const CATEGORIES = ["×ª××¦×™×•×ª", "×©×× ×™×", "××¨×•××›×™××™×§×œ×™×", "×§×‘×•×¢×™×", "×ª×•×¡×¤×•×ª"];
  const STORAGE_KEY = "enigma_v6_state";

  // Default State
  const defaultState = () => ({
    ui: {
      tab: "materials",
      showCodes: false,
      hideEssences: false,
      hideInspired: false,
      hidePrices: false,
      debugMode: false,
      sortMaterials: "new",
      sortDev: "new",
      sortFinal: "new"
    },
    defaultQty: 50,
    materials: [
      { id: "MAT_ISO", name: "ISO E Super", code: "ISO", category: "×§×‘×•×¢×™×", desc: "××•×“×•×œ×˜×•×¨ ×¢×™×§×¨×™", pricePerKg: null, pricePerMl: null, diluted: false, dilutionPercent: null },
      { id: "MAT_CIT", name: "Citrofol F", code: "CIT", category: "×§×‘×•×¢×™×", desc: "Triethyl Citrate - ×§×™×‘×•×¢ ×•×©×™×¤×•×¨ ×”×§×¨× ×”", pricePerKg: null, pricePerMl: null, diluted: false, dilutionPercent: null },
      { id: "MAT_DPG", name: "DPG", code: "DPG", category: "×§×‘×•×¢×™×", desc: "Dipropylene Glycol - ×××¡ ×•××“×œ×œ", pricePerKg: null, pricePerMl: null, diluted: false, dilutionPercent: null },
      { id: "MAT_ALC", name: "××œ×›×•×”×•×œ", code: "ALC", category: "×§×‘×•×¢×™×", desc: "Perfumers Alcohol 96%", pricePerKg: null, pricePerMl: null, diluted: false, dilutionPercent: null }
    ],
    perfumesDev: [],
    perfumesFinal: []
  });

  // ==================== FIREBASE CONFIG ====================
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyBVLibR90kjeGkSmWdHsv6MeMvYf6atkKs",
    authDomain: "enigma-58ba8.firebaseapp.com",
    projectId: "enigma-58ba8",
    storageBucket: "enigma-58ba8.firebasestorage.app",
    messagingSenderId: "509680849725",
    appId: "1:509680849725:web:440348128898bc1df3ab54"
  };

  // Firebase will be loaded dynamically
  let db = null;
  let firebaseReady = false;
  let syncStatus = "local"; // "local", "syncing", "synced", "error"

  const initFirebase = async () => {
    try {
      // Load Firebase scripts dynamically
      await loadScript("https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js");
      await loadScript("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js");
      
      firebase.initializeApp(FIREBASE_CONFIG);
      db = firebase.firestore();
      firebaseReady = true;
      console.log("Firebase initialized successfully");
      
      // Try to load from cloud
      await loadFromCloud();
      updateSyncIndicator();
    } catch (e) {
      console.warn("Firebase init failed, using local storage:", e);
      firebaseReady = false;
      updateSyncIndicator();
    }
  };

  const loadScript = (src) => {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) {
        resolve();
        return;
      }
      const script = document.createElement("script");
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  };

  const loadFromCloud = async () => {
    if (!firebaseReady || !db) return false;
    try {
      syncStatus = "syncing";
      updateSyncIndicator();
      
      const doc = await db.collection("enigma").doc("main").get();
      if (doc.exists) {
        const cloudData = doc.data();
        if (cloudData && cloudData.state) {
          const cloudState = JSON.parse(cloudData.state);
          // Check if cloud data is newer
          const localTime = state._lastModified || 0;
          const cloudTime = cloudState._lastModified || 0;
          
          console.log("Local time:", localTime, "Cloud time:", cloudTime);
          
          if (cloudTime >= localTime) {
            // Apply cloud state
            const newState = { ...defaultState(), ...cloudState };
            newState.ui = { ...defaultState().ui, ...(cloudState.ui || {}) };
            
            // Ensure arrays exist
            if (!Array.isArray(newState.materials)) newState.materials = defaultState().materials;
            if (!Array.isArray(newState.perfumesDev)) newState.perfumesDev = [];
            if (!Array.isArray(newState.perfumesFinal)) newState.perfumesFinal = [];
            
            // Update global state
            state = newState;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            console.log("Loaded from cloud - materials:", state.materials.length, "dev:", state.perfumesDev.length);
          }
        }
      } else {
        console.log("No cloud data found - first sync will create it");
      }
      syncStatus = "synced";
      updateSyncIndicator();
      return true;
    } catch (e) {
      console.warn("Cloud load failed:", e);
      syncStatus = "error";
      updateSyncIndicator();
      return false;
    }
  };

  const saveToCloud = async () => {
    if (!firebaseReady || !db) return false;
    try {
      syncStatus = "syncing";
      updateSyncIndicator();
      
      state._lastModified = Date.now();
      await db.collection("enigma").doc("main").set({
        state: JSON.stringify(state),
        updatedAt: new Date().toISOString()
      });
      
      syncStatus = "synced";
      updateSyncIndicator();
      console.log("Saved to cloud");
      return true;
    } catch (e) {
      console.warn("Cloud save failed:", e);
      syncStatus = "error";
      updateSyncIndicator();
      return false;
    }
  };

  const updateSyncIndicator = () => {
    const indicator = document.getElementById("syncIndicator");
    if (!indicator) return;
    
    const icons = {
      local: "ğŸ’¾",
      syncing: "ğŸ”„",
      synced: "â˜ï¸",
      error: "âš ï¸"
    };
    const titles = {
      local: "××¦×‘ ××§×•××™ ×‘×œ×‘×“",
      syncing: "××¡× ×›×¨×Ÿ...",
      synced: "××¡×•× ×›×¨×Ÿ ×œ×¢× ×Ÿ",
      error: "×©×’×™××ª ×¡× ×›×¨×•×Ÿ"
    };
    
    indicator.textContent = icons[syncStatus] || "ğŸ’¾";
    indicator.title = titles[syncStatus] || "";
    indicator.className = `sync-indicator ${syncStatus}`;
  };

  // Load/Save State
  const loadState = () => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return defaultState();
      const s = JSON.parse(raw);
      s.ui = { ...defaultState().ui, ...(s.ui || {}) };
      if (!Array.isArray(s.materials)) s.materials = defaultState().materials;
      if (!Array.isArray(s.perfumesDev)) s.perfumesDev = [];
      if (!Array.isArray(s.perfumesFinal)) s.perfumesFinal = [];
      s.defaultQty = num(s.defaultQty, 50);
      // Ensure fixed materials exist
      const ids = new Set(s.materials.map(m => m.id));
      if (!ids.has("MAT_DPG")) s.materials.unshift({ id: "MAT_DPG", name: "DPG", code: "DPG", category: "×§×‘×•×¢×™×", desc: "Dipropylene Glycol", pricePerKg: null, pricePerMl: null, diluted: false, dilutionPercent: null });
      return s;
    } catch (e) {
      console.warn("Load error:", e);
      return defaultState();
    }
  };

  let state = loadState();
  
  // Debounce cloud save
  let cloudSaveTimeout = null;
  const saveState = () => {
    state._lastModified = Date.now();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    
    // Debounce cloud save (save after 2 seconds of no changes)
    if (cloudSaveTimeout) clearTimeout(cloudSaveTimeout);
    cloudSaveTimeout = setTimeout(() => {
      saveToCloud();
    }, 2000);
  };

  // DOM Elements
  const $ = (id) => document.getElementById(id);
  const overlay = $("overlay");
  const modalBody = $("modalBody");
  const modalTitle = $("modalTitle");
  const fullpage = $("fullpage");
  const fpBody = $("fpBody");
  const fpTitle = $("fpTitle");
  const fpPill = $("fpPill");

  // Modal functions
  const openModal = ({ title, body }) => {
    modalTitle.textContent = title || "×—×œ×•×Ÿ";
    modalBody.innerHTML = body || "";
    overlay.classList.add("show");
  };

  const closeModal = () => {
    overlay.classList.remove("show");
    modalBody.innerHTML = "";
  };

  overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModal(); });
  $("modalClose").addEventListener("click", closeModal);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape" && overlay.classList.contains("show")) closeModal(); });

  // Full page functions
  const openFullPage = ({ title, pill, body }) => {
    fpTitle.textContent = title || "×¦×¤×™×™×”";
    fpPill.textContent = pill || "";
    fpPill.classList.toggle("hidden", !pill);
    fpBody.innerHTML = body || "";
    fullpage.classList.add("show");
    document.body.style.overflow = "hidden";
  };

  const closeFullPage = () => {
    fullpage.classList.remove("show");
    fpBody.innerHTML = "";
    document.body.style.overflow = "";
  };

  $("fpClose").addEventListener("click", closeFullPage);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape" && fullpage.classList.contains("show")) closeFullPage(); });

  // Material helpers
  const getMaterial = (id) => state.materials.find(m => m.id === id) || null;
  const getDPG = () => getMaterial("MAT_DPG");

  // Price calculations
  const basePricePerMl = (mat) => {
    if (!mat) return null;
    if (mat.pricePerMl != null && String(mat.pricePerMl).trim() !== "") return num(mat.pricePerMl, 0);
    if (mat.pricePerKg != null && String(mat.pricePerKg).trim() !== "") return num(mat.pricePerKg, 0) / 1000;
    return null;
  };

  const effectivePricePerMl = (mat) => {
    if (!mat) return null;
    const price = basePricePerMl(mat);
    if (price == null) return null;
    if (mat.diluted) {
      const oilPct = clamp(num(mat.dilutionPercent, 100), 0, 100) / 100;
      const dpg = getDPG();
      const dpgPrice = basePricePerMl(dpg) ?? 0;
      return (oilPct * price) + ((1 - oilPct) * dpgPrice);
    }
    return price;
  };

  // Essence code display
  const extractDigits = (s) => {
    const matches = String(s || "").match(/\d+/g);
    return matches ? matches.join(" ") : "";
  };

  const getEssenceCode = (m) => {
    if (!m) return "";
    const code = String(m.code || "").trim();
    if (code && /^[0-9\s]+$/.test(code)) return code;
    if (code) {
      const dig = extractDigits(code);
      if (dig) return dig;
    }
    return extractDigits(m.name);
  };

  const materialDisplayName = (m, ctx = "default") => {
    if (!m) return "";
    if (state.ui.showCodes && m.category === "×ª××¦×™×•×ª") {
      const ec = getEssenceCode(m);
      return ec || m.name;
    }
    if (ctx === "list" && m.code) return `${m.name} â€¢ ${m.code}`;
    return m.name;
  };

  // Formula calculations
  const computeFormula = (perf) => {
    const qty = clamp(num(perf.qtyMl, 50), 0, 100000);
    let totalMl = 0, totalCost = 0, costKnown = true;
    (perf.rows || []).forEach(r => {
      const ml = clamp(num(r.ml, 0), 0, 100000);
      totalMl += ml;
      const mat = getMaterial(r.materialId);
      const eff = effectivePricePerMl(mat);
      if (eff == null) costKnown = false;
      else totalCost += ml * eff;
    });
    const totalPct = qty > 0 ? (totalMl / qty) * 100 : 0;
    return {
      qty,
      totalMl,
      totalPct,
      totalCost: costKnown ? totalCost : null,
      costKnown,
      costPerMl: (costKnown && qty > 0) ? (totalCost / qty) : null
    };
  };

  // Group rows by category
  const groupRowsByCategory = (rows) => {
    const groups = {};
    (rows || []).forEach(r => {
      const m = getMaterial(r.materialId);
      const cat = (m && m.category) ? m.category : (r.catHint || "××—×¨");
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(r);
    });
    const ordered = {};
    CATEGORIES.forEach(c => { if (groups[c]) ordered[c] = groups[c]; });
    Object.keys(groups).forEach(k => { if (!ordered[k]) ordered[k] = groups[k]; });
    return ordered;
  };

  // Toggles HTML
  const renderToggles = () => `
    <div class="toggles">
      <button class="toggle-btn ${state.ui.showCodes ? 'on' : ''}" data-toggle="showCodes">ğŸ”¢ ×§×•×“×™× ×œ×ª××¦×™×•×ª</button>
      <button class="toggle-btn ${state.ui.hideEssences ? 'on' : ''}" data-toggle="hideEssences">ğŸ™ˆ ×”×¡×ª×¨ ×ª××¦×™×•×ª</button>
      <button class="toggle-btn ${state.ui.hideInspired ? 'on' : ''}" data-toggle="hideInspired">ğŸ’­ ×”×¡×ª×¨ ×‘×”×©×¨××ª</button>
      <button class="toggle-btn ${state.ui.hidePrices ? 'on' : ''}" data-toggle="hidePrices">ğŸ’° ×”×¡×ª×¨ ××—×™×¨×™×</button>
      <button class="toggle-btn ${state.ui.debugMode ? 'on' : ''}" data-toggle="debugMode">ğŸ”§ ××¦×‘ ×˜×›× ×™</button>
    </div>
  `;

  const wireToggles = (container) => {
    (container || document).querySelectorAll("[data-toggle]").forEach(btn => {
      btn.onclick = () => {
        const key = btn.getAttribute("data-toggle");
        state.ui[key] = !state.ui[key];
        saveState();
        render();
      };
    });
  };

  // Category options for select
  const categoryOptions = (selected) => CATEGORIES.map(c => 
    `<option value="${c}" ${c === selected ? "selected" : ""}>${c}</option>`
  ).join("");

  // Build select options for materials in a category
  const buildMaterialOptions = (category, selectedId) => {
    const mats = state.materials
      .filter(m => m.category === category)
      .sort((a, b) => materialDisplayName(a).localeCompare(materialDisplayName(b), "he", { numeric: true }));
    let html = `<option value="">â€” ×‘×—×¨ â€”</option>`;
    mats.forEach(m => {
      const label = escapeHtml(materialDisplayName(m, "list"));
      html += `<option value="${m.id}" ${m.id === selectedId ? "selected" : ""}>${label}</option>`;
    });
    return html;
  };

  // ==================== MATERIALS PAGE ====================
  const renderMaterials = () => {
    const left = $("leftPanel");
    const right = $("rightPanel");
    const cat = state._matCat || "×”×›×œ";
    const q = (state._matQ || "").toLowerCase();

    let filtered = state.materials.filter(m => cat === "×”×›×œ" || m.category === cat);
    if (q) filtered = filtered.filter(m => 
      ((m.name || "") + " " + (m.code || "") + " " + (m.desc || "")).toLowerCase().includes(q)
    );

    // Sorting
    const sort = state.ui.sortMaterials || "new";
    if (sort === "old") filtered.reverse();
    else if (sort === "az") filtered.sort((a, b) => (a.name || "").localeCompare(b.name || "", "he"));
    else if (sort === "za") filtered.sort((a, b) => (b.name || "").localeCompare(a.name || "", "he"));

    const needsFullRender = !$("matQ") || !$("matListBody");

    if (needsFullRender) {
      left.innerHTML = `
        <h2>ğŸ“¦ ××¡×“ × ×ª×•× ×™× â€“ ×—×•××¨×™ ×’×œ×</h2>
        ${renderToggles()}
        <div class="hr"></div>
        <div class="row">
          <div class="field" style="flex:2">
            <label>×—×™×¤×•×©</label>
            <input id="matQ" placeholder="×©×, ×§×•×“ ××• ×ª×™××•×¨..." value="${escapeHtml(state._matQ || "")}">
          </div>
          <div class="field">
            <label>×§×˜×’×•×¨×™×”</label>
            <select id="matCat">
              <option value="×”×›×œ" ${cat === "×”×›×œ" ? "selected" : ""}>×”×›×œ</option>
              ${categoryOptions(cat)}
            </select>
          </div>
          <div class="field">
            <label>××™×•×Ÿ</label>
            <select id="matSort">
              <option value="new" ${sort === "new" ? "selected" : ""}>××”×—×“×©</option>
              <option value="old" ${sort === "old" ? "selected" : ""}>××”×™×©×Ÿ</option>
              <option value="az" ${sort === "az" ? "selected" : ""}>×-×ª</option>
              <option value="za" ${sort === "za" ? "selected" : ""}>×ª-×</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnAddMat">+ ×”×•×¡×£ ×—×•××¨ ×’×œ×</button>
          <div class="pill" id="matCount">×¡×”"×›: ${filtered.length}</div>
        </div>
      `;

      right.innerHTML = `
        <h2>×¨×©×™××ª ×—×•××¨×™×</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:40%">×©×</th>
                <th style="width:15%">×§×˜×’×•×¨×™×”</th>
                <th class="${state.ui.hidePrices ? 'hidden' : ''}" style="width:15%">××—×™×¨/ml</th>
                <th style="width:12%">×“×™×œ×•×œ</th>
                <th style="width:18%">×¤×¢×•×œ×•×ª</th>
              </tr>
            </thead>
            <tbody id="matListBody"></tbody>
          </table>
        </div>
      `;
    }

    // Update count
    if ($("matCount")) $("matCount").textContent = `×¡×”"×›: ${filtered.length}`;

    // Update list
    $("matListBody").innerHTML = filtered.map(m => `
      <tr class="tr">
        <td>
          <div style="font-weight:700">${escapeHtml(materialDisplayName(m, "list"))}</div>
          <div class="small">${escapeHtml(m.desc || "")}</div>
        </td>
        <td><span class="chip">${escapeHtml(m.category)}</span></td>
        <td class="${state.ui.hidePrices ? 'hidden' : ''}">
          ${basePricePerMl(m) == null ? '<span class="muted">â€”</span>' : `<span class="mono">â‚ª${fmt(basePricePerMl(m), 4)}</span>`}
        </td>
        <td>
          ${m.diluted ? `<span class="chip">DPG ${fmt(m.dilutionPercent || 0, 0)}%</span>` : '<span class="muted">â€”</span>'}
        </td>
        <td>
          <div class="row" style="gap:6px">
            <button class="btn" data-edit="${m.id}">âœï¸</button>
            <button class="btn danger" data-del="${m.id}">ğŸ—‘ï¸</button>
          </div>
        </td>
      </tr>
    `).join("");

    if (needsFullRender) {
      wireToggles(left);
      $("matQ").oninput = (e) => { state._matQ = e.target.value; renderMaterials(); };
      $("matCat").onchange = (e) => { state._matCat = e.target.value; renderMaterials(); };
      $("matSort").onchange = (e) => { state.ui.sortMaterials = e.target.value; saveState(); renderMaterials(); };
      $("btnAddMat").onclick = () => openMaterialEditor();
    }

    $("matListBody").querySelectorAll("[data-edit]").forEach(btn => {
      btn.onclick = () => openMaterialEditor(btn.getAttribute("data-edit"));
    });
    $("matListBody").querySelectorAll("[data-del]").forEach(btn => {
      btn.onclick = () => deleteMaterial(btn.getAttribute("data-del"));
    });
  };

  const openMaterialEditor = (id = null) => {
    const isNew = !id;
    const m = isNew ? {
      id: uid(),
      name: "",
      code: "",
      category: "×ª××¦×™×•×ª",
      desc: "",
      pricePerKg: null,
      pricePerMl: null,
      diluted: false,
      dilutionPercent: 50
    } : { ...getMaterial(id) };

    if (!m) return;

    openModal({
      title: isNew ? "×”×•×¡×¤×ª ×—×•××¨ ×’×œ×" : "×¢×¨×™×›×ª ×—×•××¨ ×’×œ×",
      body: `
        <div class="row">
          <div class="field"><label>×©×</label><input id="m_name" value="${escapeHtml(m.name)}" placeholder="×©× ×”×—×•××¨"></div>
          <div class="field"><label>×§×•×“ (××•×¤×¦×™×•× ×œ×™)</label><input id="m_code" value="${escapeHtml(m.code || "")}" placeholder="×§×•×“ ×–×™×”×•×™"></div>
        </div>
        <div class="row" style="margin-top:12px">
          <div class="field"><label>×§×˜×’×•×¨×™×”</label><select id="m_cat">${categoryOptions(m.category)}</select></div>
          <div class="field ${state.ui.hidePrices ? 'hidden' : ''}">
            <label>××—×™×¨ â‚ª ×œ×§"×’</label>
            <input id="m_priceKg" inputmode="decimal" value="${m.pricePerKg ?? ""}" placeholder="×œ×“×•×’××”: 300">
          </div>
          <div class="field ${state.ui.hidePrices ? 'hidden' : ''}">
            <label>××—×™×¨ â‚ª ×œ-ml (××•×¤×¦×™×•× ×œ×™)</label>
            <input id="m_priceMl" inputmode="decimal" value="${m.pricePerMl ?? ""}" placeholder="×¨×™×§ = ×—×™×©×•×‘ ××•×˜×•××˜×™">
          </div>
        </div>
        <div class="field" style="margin-top:12px">
          <label>×ª×™××•×¨</label>
          <textarea id="m_desc" style="min-height:80px">${escapeHtml(m.desc || "")}</textarea>
        </div>
        <div class="hr"></div>
        <div class="row">
          <label style="min-width:120px">××“×•×œ×œ ×‘-DPG?</label>
          <input type="checkbox" id="m_dil" ${m.diluted ? "checked" : ""} style="width:24px;height:24px">
          <span class="small">×—×™×©×•×‘ ×”××—×™×¨ ×™×›×œ×•×œ DPG ×œ×¤×™ ×”××—×•×–</span>
        </div>
        <div id="dilBox" class="${m.diluted ? '' : 'hidden'}" style="margin-top:12px">
          <div class="row">
            <div class="field"><label>××—×•×– ×—×•××¨ (×”×©××¨ DPG)</label><input id="m_dilPct" inputmode="numeric" value="${m.dilutionPercent ?? 50}" placeholder="50"></div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="m_cancel">×‘×™×˜×•×œ</button>
          <button class="btn primary" id="m_save">ğŸ’¾ ×©××•×¨</button>
        </div>
      `
    });

    $("m_dil").onchange = () => $("dilBox").classList.toggle("hidden", !$("m_dil").checked);
    $("m_cancel").onclick = closeModal;
    $("m_save").onclick = () => {
      const name = $("m_name").value.trim();
      if (!name) { alert("×—×•×‘×” ×©×"); return; }

      const updated = {
        ...m,
        name,
        code: $("m_code").value.trim(),
        category: $("m_cat").value,
        desc: $("m_desc").value.trim(),
        pricePerKg: $("m_priceKg").value.trim() === "" ? null : num($("m_priceKg").value),
        pricePerMl: $("m_priceMl").value.trim() === "" ? null : num($("m_priceMl").value),
        diluted: $("m_dil").checked,
        dilutionPercent: $("m_dil").checked ? clamp(num($("m_dilPct").value, 50), 0, 100) : null
      };

      const idx = state.materials.findIndex(x => x.id === m.id);
      if (idx >= 0) state.materials[idx] = updated;
      else state.materials.unshift(updated);

      saveState();
      closeModal();
      render();
    };
  };

  const deleteMaterial = (id) => {
    const mat = getMaterial(id);
    if (!mat) return;
    if (id === "MAT_DPG") { alert("×œ× × ×™×ª×Ÿ ×œ××—×•×§ DPG - × ×“×¨×© ×œ×—×™×©×•×‘×™ ×“×™×œ×•×œ"); return; }
    if (!confirm(`×œ××—×•×§ ××ª "${mat.name}"?`)) return;

    state.materials = state.materials.filter(m => m.id !== id);
    // Clean from formulas
    const clean = (p) => { p.rows = (p.rows || []).filter(r => r.materialId !== id); return p; };
    state.perfumesDev = state.perfumesDev.map(clean);
    state.perfumesFinal = state.perfumesFinal.map(clean);

    saveState();
    render();
  };

  // ==================== PRICING PAGE ====================
  const renderPricing = () => {
    const left = $("leftPanel");
    const right = $("rightPanel");
    const q = (state._priceQ || "").toLowerCase();
    const cat = state._priceCat || "×”×›×œ";

    let items = state.materials.filter(m => cat === "×”×›×œ" || m.category === cat);
    if (q) items = items.filter(m => ((m.name || "") + " " + (m.code || "")).toLowerCase().includes(q));

    const needsFullRender = !$("prQ") || !$("priceListBody");

    if (needsFullRender) {
      left.innerHTML = `
        <h2>ğŸ’° ×”×–× ×ª ××—×™×¨×™×</h2>
        <div class="small">×¢×“×›×•×Ÿ ××—×™×¨×™× ××¨×•×›×– - ×”×–×Ÿ ××—×™×¨ ×œ-×§"×’ ××• ×œ-ml (×”××¢×¨×›×ª ×ª×—×©×‘ ××•×˜×•××˜×™×ª)</div>
        <div class="hr"></div>
        <div class="row">
          <div class="field" style="flex:2">
            <label>×—×™×¤×•×©</label>
            <input id="prQ" value="${escapeHtml(state._priceQ || "")}" placeholder="×©× ××• ×§×•×“...">
          </div>
          <div class="field">
            <label>×§×˜×’×•×¨×™×”</label>
            <select id="prCat">
              <option value="×”×›×œ" ${cat === "×”×›×œ" ? "selected" : ""}>×”×›×œ</option>
              ${categoryOptions(cat)}
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn success" id="prSave">ğŸ’¾ ×©××•×¨ ××—×™×¨×™×</button>
          <div class="pill" id="priceCount">×¤×¨×™×˜×™×: ${items.length}</div>
        </div>

        <div class="hr"></div>
        <h3 style="color:var(--accent);margin:12px 0">ğŸ“Š ×—×™×©×•×‘ ×¢×œ×•×ª ×¤×•×¨××•×œ×”</h3>
        <div class="field">
          <label>×‘×—×¨ ×¤×•×¨××•×œ×”</label>
          <select id="perfSelect">
            <optgroup label="×¤×™×ª×•×—×™×">
              ${state.perfumesDev.map(p => `<option value="dev:${p.id}">${escapeHtml(p.name)}${p.code ? ` â€¢ ${p.code}` : ""}</option>`).join("")}
            </optgroup>
            <optgroup label="×‘×©××™× ×¡×•×¤×™×™×">
              ${state.perfumesFinal.map(p => `<option value="final:${p.id}">${escapeHtml(p.name)}${p.code ? ` â€¢ ${p.code}` : ""}</option>`).join("")}
            </optgroup>
          </select>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="calcCost">×—×©×‘ ×¢×œ×•×ª</button>
        </div>
        <div id="costResult" style="margin-top:12px"></div>
      `;

      right.innerHTML = `
        <h2>×˜×‘×œ×ª ××—×™×¨×™×</h2>
        <div class="small" style="margin-bottom:12px">×”×–×Ÿ ××—×™×¨ ×œ-×§"×’ ××• ×œ-ml â€¢ ×¡××Ÿ ×× ××“×•×œ×œ ×‘-DPG</div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th style="width:35%">×—×•××¨</th>
              <th style="width:18%">â‚ª/×§"×’</th>
              <th style="width:18%">â‚ª/ml</th>
              <th style="width:12%">××“×•×œ×œ?</th>
              <th style="width:12%">% ×—×•××¨</th>
              <th style="width:15%">×¢×œ×•×ª/ml</th>
            </tr></thead>
            <tbody id="priceListBody"></tbody>
          </table>
        </div>
      `;
    }

    // Update count
    if ($("priceCount")) $("priceCount").textContent = `×¤×¨×™×˜×™×: ${items.length}`;

    // Update list
    $("priceListBody").innerHTML = items.map(m => {
      const effPrice = effectivePricePerMl(m);
      return `
        <tr class="tr">
          <td>
            <div style="font-weight:600">${escapeHtml(materialDisplayName(m, "list"))}</div>
            <div class="small">${escapeHtml(m.category)}</div>
          </td>
          <td>
            <input data-pricekg="${m.id}" inputmode="decimal" value="${m.pricePerKg ?? ""}" placeholder="â€”" style="width:70px">
          </td>
          <td>
            <input data-priceml="${m.id}" inputmode="decimal" value="${m.pricePerMl ?? ""}" placeholder="â€”" style="width:70px">
          </td>
          <td style="text-align:center">
            <input type="checkbox" data-diluted="${m.id}" ${m.diluted ? "checked" : ""} style="width:20px;height:20px">
          </td>
          <td>
            <input data-dilpct="${m.id}" inputmode="numeric" value="${m.diluted ? (m.dilutionPercent ?? 50) : ""}" placeholder="50" style="width:50px" ${m.diluted ? "" : "disabled"}>
          </td>
          <td class="mono" style="color:var(--accent)">
            ${effPrice == null ? '<span class="muted">â€”</span>' : `â‚ª${fmt(effPrice, 4)}`}
          </td>
        </tr>
      `;
    }).join("");

    if (needsFullRender) {
      $("prQ").oninput = (e) => { state._priceQ = e.target.value; renderPricing(); };
      $("prCat").onchange = (e) => { state._priceCat = e.target.value; renderPricing(); };

      $("prSave").onclick = () => {
        $("priceListBody").querySelectorAll("tr").forEach(row => {
          const kgInp = row.querySelector("[data-pricekg]");
          const mlInp = row.querySelector("[data-priceml]");
          const dilChk = row.querySelector("[data-diluted]");
          const dilPct = row.querySelector("[data-dilpct]");
          
          if (!kgInp) return;
          const id = kgInp.getAttribute("data-pricekg");
          const m = getMaterial(id);
          if (m) {
            m.pricePerKg = kgInp.value.trim() === "" ? null : num(kgInp.value);
            m.pricePerMl = mlInp.value.trim() === "" ? null : num(mlInp.value);
            m.diluted = dilChk.checked;
            m.dilutionPercent = dilChk.checked ? clamp(num(dilPct.value, 50), 1, 99) : null;
          }
        });
        saveState();
        renderPricing(); // Refresh to show updated effective prices
        alert("× ×©××¨!");
      };

      $("calcCost").onclick = () => {
        const val = $("perfSelect").value;
        if (!val) return;
        const [mode, id] = val.split(":");
        const perf = (mode === "final" ? state.perfumesFinal : state.perfumesDev).find(p => p.id === id);
        if (!perf) return;

        const calc = computeFormula(perf);
        const missing = [];
        (perf.rows || []).forEach(r => {
          const m = getMaterial(r.materialId);
          if (effectivePricePerMl(m) == null && r.ml > 0) {
            missing.push(m ? m.name : r.materialId);
          }
        });

        let html = `<div class="pill" style="font-size:1.1rem;padding:10px 16px;background:var(--accent);color:var(--bg)">×¢×œ×•×ª: â‚ª${calc.totalCost == null ? "â€”" : fmt(calc.totalCost, 2)}</div>`;
        if (missing.length) {
          html += `<div class="warn-box" style="margin-top:8px"><strong>×—×¡×¨×™× ××—×™×¨×™×:</strong><br>${missing.join(", ")}</div>`;
        }
        $("costResult").innerHTML = html;
      };
    }

    // Wire diluted checkbox toggle
    $("priceListBody").querySelectorAll("[data-diluted]").forEach(chk => {
      chk.onchange = () => {
        const id = chk.getAttribute("data-diluted");
        const row = chk.closest("tr");
        const pctInput = row.querySelector("[data-dilpct]");
        pctInput.disabled = !chk.checked;
        if (!chk.checked) pctInput.value = "";
        else if (!pctInput.value) pctInput.value = "50";
      };
    });

    // Auto-save on blur (always rewire since list changes)
    $("priceListBody").querySelectorAll("[data-price]").forEach(inp => {
      inp.onblur = () => {
        const id = inp.getAttribute("data-price");
        const m = getMaterial(id);
        if (m) {
          m.pricePerMl = inp.value.trim() === "" ? null : num(inp.value);
          saveState();
        }
      };
    });
  };

  // ==================== PERFUMES PAGES ====================
  const getPerfumeList = (mode) => mode === "final" ? state.perfumesFinal : state.perfumesDev;
  const setPerfumeList = (mode, list) => { if (mode === "final") state.perfumesFinal = list; else state.perfumesDev = list; };
  const findPerfume = (mode, id) => getPerfumeList(mode).find(p => p.id === id) || null;

  const basePerfume = () => ({
    id: uid(),
    name: "",
    code: "",
    inspiredBy: "",
    notes: "",
    date: todayISO(),
    updatedAt: todayISO(),
    qtyMl: state.defaultQty || 50,
    rows: [],
    marketingText: "",
    notesTop: "",
    notesHeart: "",
    notesBase: ""
  });

  const renderPerfumes = (mode) => {
    const isFinal = mode === "final";
    const list = getPerfumeList(mode);
    const left = $("leftPanel");
    const right = $("rightPanel");

    const q = ((isFinal ? state._finalQ : state._devQ) || "").toLowerCase();
    let filtered = list.filter(p => 
      ((p.name || "") + " " + (p.code || "") + " " + (p.inspiredBy || "") + " " + (p.notes || "")).toLowerCase().includes(q)
    );

    // Sorting
    const sortKey = isFinal ? state.ui.sortFinal : state.ui.sortDev || "new";
    if (sortKey === "az") filtered.sort((a, b) => (a.name || "").localeCompare(b.name || "", "he"));
    else if (sortKey === "za") filtered.sort((a, b) => (b.name || "").localeCompare(a.name || "", "he"));
    else if (sortKey === "old") filtered.sort((a, b) => (a.updatedAt || a.date || "").localeCompare(b.updatedAt || b.date || ""));
    else filtered.sort((a, b) => (b.updatedAt || b.date || "").localeCompare(a.updatedAt || a.date || ""));

    // Check if we need full render or just list update
    const needsFullRender = !$("perfQ") || !$("perfListBody");
    
    if (needsFullRender) {
      left.innerHTML = `
        <h2>${isFinal ? "âœ¨ ×‘×©××™× ×¡×•×¤×™×™×" : "ğŸ§ª ×¤×™×ª×•×—×™×"}</h2>
        ${renderToggles()}
        <div class="hr"></div>
        <div class="row">
          <div class="field" style="flex:2">
            <label>×—×™×¤×•×©</label>
            <input id="perfQ" value="${escapeHtml(isFinal ? state._finalQ : state._devQ || "")}" placeholder="×©×, ×§×•×“, ×‘×”×©×¨××ª...">
          </div>
          <div class="field">
            <label>×›××•×ª ×‘×¨×™×¨×ª ××—×“×œ (ml)</label>
            <input id="defQty" inputmode="numeric" value="${state.defaultQty || 50}">
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div class="field">
            <label>××™×•×Ÿ</label>
            <select id="perfSort">
              <option value="new" ${sortKey === "new" ? "selected" : ""}>××”×—×“×©</option>
              <option value="old" ${sortKey === "old" ? "selected" : ""}>××”×™×©×Ÿ</option>
              <option value="az" ${sortKey === "az" ? "selected" : ""}>×-×ª</option>
              <option value="za" ${sortKey === "za" ? "selected" : ""}>×ª-×</option>
            </select>
          </div>
          <button class="btn primary" id="btnAddPerf">+ ×¤×•×¨××•×œ×” ×—×“×©×”</button>
          <div class="pill" id="perfCount">×¡×”"×›: ${filtered.length}</div>
        </div>
      `;

      right.innerHTML = `
        <h2>×¨×©×™××ª ${isFinal ? "×‘×©××™×" : "×¤×™×ª×•×—×™×"}</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:45%">×‘×•×©×</th>
                <th style="width:25%">×¡×˜×˜×•×¡</th>
                <th style="width:30%">×¤×¢×•×œ×•×ª</th>
              </tr>
            </thead>
            <tbody id="perfListBody"></tbody>
          </table>
        </div>
      `;
    }

    // Update just the list and count
    if ($("perfCount")) $("perfCount").textContent = `×¡×”"×›: ${filtered.length}`;
    
    const listHtml = filtered.map(p => {
      const calc = computeFormula(p);
      const ok = Math.abs(calc.totalPct - 100) < 0.05;
      return `
        <tr class="tr">
          <td>
            <div style="font-weight:700;font-size:1rem">${escapeHtml(p.name)} ${p.code ? `<span class="mono muted">â€¢ ${escapeHtml(p.code)}</span>` : ""}</div>
            ${state.ui.hideInspired ? "" : `<div class="small">×‘×”×©×¨××ª: ${escapeHtml(p.inspiredBy || "â€”")}</div>`}
            <div class="small">×¢×•×“×›×Ÿ: ${escapeHtml(p.updatedAt || p.date || todayISO())}</div>
          </td>
          <td>
            <span class="chip ${ok ? '' : 'warn'}">${fmt(calc.totalPct, 1)}%</span>
            ${state.ui.hidePrices ? "" : `<div class="small mono" style="margin-top:4px">${calc.totalCost == null ? "â€”" : `â‚ª${fmt(calc.totalCost, 2)}`}</div>`}
          </td>
          <td>
            <div class="row" style="gap:6px;flex-wrap:wrap">
              <button class="btn" data-view="${p.id}">ğŸ‘ï¸</button>
              <button class="btn" data-edit="${p.id}">âœï¸</button>
              <button class="btn danger" data-del="${p.id}">ğŸ—‘ï¸</button>
              ${isFinal ? "" : `<button class="btn success" data-toFinal="${p.id}">âœ¨</button>`}
            </div>
          </td>
        </tr>
      `;
    }).join("");
    
    $("perfListBody").innerHTML = listHtml;

    if (needsFullRender) {
      wireToggles(left);
      $("perfQ").oninput = (e) => {
        if (isFinal) state._finalQ = e.target.value;
        else state._devQ = e.target.value;
        renderPerfumes(mode);
      };
      $("defQty").onchange = (e) => {
        state.defaultQty = clamp(num(e.target.value, 50), 1, 100000);
        saveState();
      };
      $("perfSort").onchange = (e) => {
        if (isFinal) state.ui.sortFinal = e.target.value;
        else state.ui.sortDev = e.target.value;
        saveState();
        renderPerfumes(mode);
      };
      $("btnAddPerf").onclick = () => openPerfumeEditor(mode);
    }

    // Always re-wire list buttons (list gets re-rendered on search)
    $("perfListBody").querySelectorAll("[data-view]").forEach(btn => {
      btn.onclick = () => openPerfumeViewer(mode, btn.getAttribute("data-view"));
    });
    $("perfListBody").querySelectorAll("[data-edit]").forEach(btn => {
      btn.onclick = () => openPerfumeEditor(mode, btn.getAttribute("data-edit"));
    });
    $("perfListBody").querySelectorAll("[data-del]").forEach(btn => {
      btn.onclick = () => deletePerfume(mode, btn.getAttribute("data-del"));
    });
    $("perfListBody").querySelectorAll("[data-toFinal]").forEach(btn => {
      btn.onclick = () => moveToFinal(btn.getAttribute("data-toFinal"));
    });
  };

  const deletePerfume = (mode, id) => {
    const p = findPerfume(mode, id);
    if (!p) return;
    if (!confirm(`×œ××—×•×§ ××ª "${p.name}"?`)) return;
    setPerfumeList(mode, getPerfumeList(mode).filter(x => x.id !== id));
    saveState();
    render();
  };

  const moveToFinal = (devId) => {
    const p = findPerfume("dev", devId);
    if (!p) return;
    const copy = JSON.parse(JSON.stringify(p));
    copy.id = uid();
    copy.updatedAt = todayISO();
    state.perfumesFinal.unshift(copy);
    state.perfumesDev = state.perfumesDev.filter(x => x.id !== devId);
    saveState();
    render();
  };

  const openPerfumeViewer = (mode, id) => {
    const isFinal = mode === "final";
    const p = findPerfume(mode, id);
    if (!p) return;

    const calc = computeFormula(p);
    const pctOk = Math.abs(calc.totalPct - 100) < 0.05;
    const groups = groupRowsByCategory(p.rows || []);

    let categoriesHtml = "";
    const cats = Object.keys(groups).filter(c => !(state.ui.hideEssences && c === "×ª××¦×™×•×ª"));

    cats.forEach(cat => {
      const rows = groups[cat];
      categoriesHtml += `
        <div class="cat-section">
          <div class="cat-header">
            <span class="chip">${escapeHtml(cat)}</span>
            <span class="small">${rows.length} ×¨×›×™×‘×™×</span>
          </div>
          ${rows.map(r => {
            const m = getMaterial(r.materialId);
            const ml = num(r.ml, 0);
            const pct = calc.qty > 0 ? (ml / calc.qty * 100) : 0;
            const eff = effectivePricePerMl(m);
            const cost = eff == null ? null : ml * eff;
            return `
              <div class="cat-row">
                <div class="name">${escapeHtml(m ? materialDisplayName(m) : "â€”")}</div>
                <div class="ml-col mono">${fmt(ml, 2)} ml</div>
                <div class="pct-col mono">${fmt(pct, 2)}%</div>
                ${state.ui.hidePrices ? "" : `<div class="cost-col mono">${cost == null ? "â€”" : `â‚ª${fmt(cost, 2)}`}</div>`}
              </div>
            `;
          }).join("")}
        </div>
      `;
    });

    openFullPage({
      title: p.name,
      pill: isFinal ? "×¡×•×¤×™" : "×¤×™×ª×•×—",
      body: `
        <div class="row between" style="margin-bottom:16px">
          <div>
            <div style="font-size:1.3rem;font-weight:800;color:var(--accent)">${escapeHtml(p.name)} ${p.code ? `<span class="mono muted">â€¢ ${escapeHtml(p.code)}</span>` : ""}</div>
            ${state.ui.hideInspired ? "" : `<div class="small">×‘×”×©×¨××ª: ${escapeHtml(p.inspiredBy || "â€”")}</div>`}
            <div class="small">×ª××¨×™×š: ${escapeHtml(p.date || todayISO())}</div>
          </div>
          <span class="chip">${isFinal ? "×¡×•×¤×™" : "×¤×™×ª×•×—"}</span>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="k">×›××•×ª</div>
            <div class="v mono">${fmt(calc.qty, 0)} ml</div>
          </div>
          <div class="stat">
            <div class="k">×¡×”"×› ×‘×¤×•×¨××•×œ×”</div>
            <div class="v mono">${fmt(calc.totalMl, 2)} ml</div>
          </div>
          <div class="stat">
            <div class="k">×¡×”"×› %</div>
            <div class="v ${pctOk ? 'ok' : 'warn'}">${fmt(calc.totalPct, 1)}%</div>
            <div class="bar ${calc.totalPct > 100 ? 'over' : ''}"><div style="width:${clamp(calc.totalPct, 0, 100)}%"></div></div>
          </div>
          ${state.ui.hidePrices ? "" : `
            <div class="stat">
              <div class="k">×¢×œ×•×ª ×›×•×œ×œ×ª</div>
              <div class="v">${calc.totalCost == null ? '<span class="muted">â€”</span>' : `â‚ª${fmt(calc.totalCost, 2)}`}</div>
              <div class="small">${calc.costPerMl == null ? "" : `â‚ª${fmt(calc.costPerMl, 4)} ×œ-ml`}</div>
            </div>
          `}
        </div>

        ${isFinal ? `
          <div class="section-title">×ª×™××•×¨ ×©×™×•×•×§×™</div>
          <div class="card" style="background:rgba(255,255,255,0.03);padding:16px">
            ${escapeHtml(p.marketingText || "â€”").replace(/\n/g, "<br>")}
          </div>
          <div class="section-title">×ª×•×•×™×</div>
          <div class="row" style="gap:12px">
            <div class="card" style="flex:1;padding:12px;background:rgba(255,255,255,0.03)">
              <div class="chip" style="margin-bottom:8px">ğŸ” ×¨××©</div>
              <div>${escapeHtml(p.notesTop || "â€”")}</div>
            </div>
            <div class="card" style="flex:1;padding:12px;background:rgba(255,255,255,0.03)">
              <div class="chip" style="margin-bottom:8px">ğŸ’— ×œ×‘</div>
              <div>${escapeHtml(p.notesHeart || "â€”")}</div>
            </div>
            <div class="card" style="flex:1;padding:12px;background:rgba(255,255,255,0.03)">
              <div class="chip" style="margin-bottom:8px">ğŸŒ³ ×‘×¡×™×¡</div>
              <div>${escapeHtml(p.notesBase || "â€”")}</div>
            </div>
          </div>
        ` : ""}

        ${p.notes ? `
          <div class="section-title">×”×¢×¨×•×ª</div>
          <div class="card" style="background:rgba(255,255,255,0.03);padding:12px">
            ${escapeHtml(p.notes).replace(/\n/g, "<br>")}
          </div>
        ` : ""}

        <div class="section-title">×”×¨×›×‘</div>
        ${categoriesHtml || '<div class="muted">××™×Ÿ ×¨×›×™×‘×™×</div>'}
      `
    });
  };

  const openPerfumeEditor = (mode, id = null) => {
    const isFinal = mode === "final";
    const isNew = !id;
    let p = isNew ? basePerfume() : JSON.parse(JSON.stringify(findPerfume(mode, id)));
    if (!p) return;

    // Add default fixed materials for new perfumes
    if (isNew) {
      ["MAT_CIT", "MAT_DPG", "MAT_ISO", "MAT_ALC"].forEach(mid => {
        if (getMaterial(mid)) p.rows.push({ id: uid(), materialId: mid, ml: 0, catHint: "×§×‘×•×¢×™×" });
      });
    }

    const renderEditor = () => {
      const calc = computeFormula(p);
      const pctOk = Math.abs(calc.totalPct - 100) < 0.05;
      const groups = groupRowsByCategory(p.rows);
      const cats = CATEGORIES.filter(c => !(state.ui.hideEssences && c === "×ª××¦×™×•×ª"));

      let rowsHtml = `
        <div class="cat-header-row" style="display:flex;gap:12px;padding:8px 12px;background:var(--panel2);border-radius:8px;margin-bottom:12px;font-size:0.85rem;color:var(--muted);position:sticky;top:0;z-index:10">
          <div style="flex:2">×—×•××¨</div>
          <div style="width:80px;text-align:center">×"×œ</div>
          <div style="width:60px;text-align:center">%</div>
          ${state.ui.hidePrices ? "" : `<div style="width:80px;text-align:center">×¢×œ×•×ª</div>`}
          <div style="width:50px"></div>
        </div>
      `;
      cats.forEach(cat => {
        // For ×§×‘×•×¢×™× - use fixed order. For other categories - keep user order (no sorting)
        const rows = (groups[cat] || []);
        if (cat === "×§×‘×•×¢×™×") {
          rows.sort((a, b) => {
            const order = ["MAT_CIT", "MAT_DPG", "MAT_ISO", "MAT_ALC"];
            return order.indexOf(a.materialId) - order.indexOf(b.materialId);
          });
        }
        // Other categories: no sorting - keep original order from p.rows

        rowsHtml += `
          <div class="cat-section">
            <div class="cat-header">
              <span class="chip">${escapeHtml(cat)}</span>
              <button class="btn primary" style="padding:6px 12px" data-addrow="${cat}">+ ×”×•×¡×£</button>
            </div>
            ${rows.length ? rows.map(r => {
              const m = getMaterial(r.materialId);
              const ml = num(r.ml, 0);
              const pct = p.qtyMl > 0 ? (ml / p.qtyMl * 100) : 0;
              const eff = effectivePricePerMl(m);
              const cost = eff == null ? null : ml * eff;
              return `
                <div class="cat-row">
                  <div class="name">
                    <select data-row="${r.id}" data-cat="${cat}" style="max-width:200px">
                      ${buildMaterialOptions(cat, r.materialId)}
                    </select>
                  </div>
                  <div class="ml-col">
                    <input data-ml="${r.id}" inputmode="decimal" value="${ml}" style="width:80px;text-align:center">
                  </div>
                  <div class="pct-col mono">${fmt(pct, 2)}%</div>
                  ${state.ui.hidePrices ? "" : `<div class="cost-col mono">${cost == null ? "â€”" : `â‚ª${fmt(cost, 2)}`}</div>`}
                  <div class="action-col">
                    <button class="btn danger" data-delrow="${r.id}" style="padding:6px 10px">âœ•</button>
                  </div>
                </div>
              `;
            }).join("") : '<div class="muted" style="padding:10px">××™×Ÿ ×©×•×¨×•×ª ×‘×§×˜×’×•×¨×™×”</div>'}
          </div>
        `;
      });

      fpBody.innerHTML = `
        <div class="row">
          <div class="field" style="flex:2"><label>×©×</label><input id="p_name" value="${escapeHtml(p.name)}" placeholder="×©× ×”×‘×•×©×"></div>
          <div class="field"><label>×§×•×“</label><input id="p_code" value="${escapeHtml(p.code || "")}" placeholder="EN-..."></div>
        </div>
        ${state.ui.hideInspired ? "" : `
          <div class="field" style="margin-top:12px">
            <label>×‘×”×©×¨××ª</label>
            <input id="p_insp" value="${escapeHtml(p.inspiredBy || "")}" placeholder="×©× ×”×‘×•×©× ×”××§×•×¨×™...">
          </div>
        `}
        <div class="row" style="margin-top:12px">
          <div class="field" style="flex:2">
            <label>×”×¢×¨×•×ª</label>
            <textarea id="p_notes" style="min-height:60px">${escapeHtml(p.notes || "")}</textarea>
          </div>
          <div class="field">
            <label>×ª××¨×™×š</label>
            <input id="p_date" type="date" value="${p.date || todayISO()}">
          </div>
          <div class="field">
            <label>×›××•×ª (ml)</label>
            <input id="p_qty" inputmode="decimal" value="${p.qtyMl}">
          </div>
        </div>

        ${isFinal ? `
          <div class="section-title">×ª×™××•×¨ ×©×™×•×•×§×™</div>
          <textarea id="p_mkt" style="min-height:80px">${escapeHtml(p.marketingText || "")}</textarea>
          <div class="section-title">×ª×•×•×™×</div>
          <div class="row">
            <div class="field"><label>ğŸ” ×¨××©</label><input id="p_top" value="${escapeHtml(p.notesTop || "")}"></div>
            <div class="field"><label>ğŸ’— ×œ×‘</label><input id="p_heart" value="${escapeHtml(p.notesHeart || "")}"></div>
            <div class="field"><label>ğŸŒ³ ×‘×¡×™×¡</label><input id="p_base" value="${escapeHtml(p.notesBase || "")}"></div>
          </div>
        ` : ""}

        <div class="section-title">×”×¨×›×‘</div>
        <div class="row" style="margin-bottom:12px">
          <button class="btn primary" id="refreshCalc">ğŸ”„ ×—×©×‘ ×¢×œ×•×ª</button>
          <button class="btn" id="normalize">âš–ï¸ ×”×©×œ× ×œ-100%</button>
          <div class="pill" id="sumPill">
            ×¡×”"×›: <span class="${pctOk ? 'ok' : 'warn'}">${fmt(calc.totalPct, 1)}%</span>
            ${state.ui.hidePrices ? "" : (calc.totalCost == null ? "" : ` â€¢ â‚ª${fmt(calc.totalCost, 2)}`)}
          </div>
        </div>
        ${rowsHtml}

        <div class="hr"></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="p_cancel">×‘×™×˜×•×œ</button>
          <button class="btn primary" id="p_save">ğŸ’¾ ×©××•×¨</button>
        </div>
      `;

      // Wire events
      $("p_qty").onblur = () => {
        p.qtyMl = clamp(num($("p_qty").value, 50), 0, 100000);
      };

      $("refreshCalc").onclick = () => {
        // Update all ml values from inputs before recalculating
        fpBody.querySelectorAll("[data-ml]").forEach(inp => {
          const rid = inp.getAttribute("data-ml");
          const row = p.rows.find(r => r.id === rid);
          if (row) row.ml = clamp(num(inp.value, 0), 0, 100000);
        });
        p.qtyMl = clamp(num($("p_qty").value, 50), 0, 100000);
        renderEditor();
      };

      $("normalize").onclick = () => {
        // First update all values
        fpBody.querySelectorAll("[data-ml]").forEach(inp => {
          const rid = inp.getAttribute("data-ml");
          const row = p.rows.find(r => r.id === rid);
          if (row) row.ml = clamp(num(inp.value, 0), 0, 100000);
        });
        const qty = clamp(num($("p_qty").value, p.qtyMl), 0, 100000);
        p.qtyMl = qty;
        if (qty <= 0) { alert("×§×‘×¢ ×›××•×ª"); return; }
        let total = 0;
        p.rows.forEach(r => total += num(r.ml, 0));
        const diff = qty - total;
        const alcRow = p.rows.find(r => r.materialId === "MAT_ALC");
        if (alcRow) alcRow.ml = clamp(num(alcRow.ml, 0) + diff, 0, 100000);
        else p.rows.push({ id: uid(), materialId: "MAT_ALC", ml: clamp(diff, 0, 100000), catHint: "×§×‘×•×¢×™×" });
        renderEditor();
      };

      fpBody.querySelectorAll("[data-addrow]").forEach(btn => {
        btn.onclick = () => {
          // Save current values before adding row
          fpBody.querySelectorAll("[data-ml]").forEach(inp => {
            const rid = inp.getAttribute("data-ml");
            const row = p.rows.find(r => r.id === rid);
            if (row) row.ml = clamp(num(inp.value, 0), 0, 100000);
          });
          const cat = btn.getAttribute("data-addrow");
          p.rows.push({ id: uid(), materialId: "", ml: 0, catHint: cat });
          renderEditor();
        };
      });

      fpBody.querySelectorAll("[data-row]").forEach(sel => {
        sel.onchange = () => {
          const rid = sel.getAttribute("data-row");
          const rowIndex = p.rows.findIndex(r => r.id === rid);
          const row = p.rows[rowIndex];
          if (row) {
            row.materialId = sel.value;
            // If a material was selected, automatically add a new empty row AFTER this one in the same category
            if (sel.value) {
              const cat = row.catHint || "×ª××¦×™×•×ª";
              // Check if there's already an empty row in this category
              const hasEmpty = p.rows.some(r => r.catHint === cat && !r.materialId);
              if (!hasEmpty) {
                // Insert after current row, not at the end
                const newRow = { id: uid(), materialId: "", ml: 0, catHint: cat };
                p.rows.splice(rowIndex + 1, 0, newRow);
                renderEditor();
              }
            }
          }
        };
      });

      fpBody.querySelectorAll("[data-ml]").forEach(inp => {
        // Select all text on focus (so 0 gets replaced easily)
        inp.onfocus = () => {
          inp.select();
        };
        // Update data on input
        inp.oninput = () => {
          const rid = inp.getAttribute("data-ml");
          const row = p.rows.find(r => r.id === rid);
          if (row) row.ml = clamp(num(inp.value, 0), 0, 100000);
        };
        // Enter key jumps to next empty select in same category
        inp.onkeydown = (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const rid = inp.getAttribute("data-ml");
            const rowIndex = p.rows.findIndex(r => r.id === rid);
            const row = p.rows[rowIndex];
            if (row) {
              row.ml = clamp(num(inp.value, 0), 0, 100000);
              const cat = row.catHint || "×ª××¦×™×•×ª";
              // Find next empty row in same category or add one
              let nextEmptyRow = p.rows.find((r, i) => i > rowIndex && r.catHint === cat && !r.materialId);
              if (!nextEmptyRow) {
                // Add new row after current
                nextEmptyRow = { id: uid(), materialId: "", ml: 0, catHint: cat };
                p.rows.splice(rowIndex + 1, 0, nextEmptyRow);
              }
              renderEditor();
              // Focus the new select after render
              setTimeout(() => {
                const newSelect = fpBody.querySelector(`select[data-row="${nextEmptyRow.id}"]`);
                if (newSelect) newSelect.focus();
              }, 50);
            }
          }
        };
      });

      fpBody.querySelectorAll("[data-delrow]").forEach(btn => {
        btn.onclick = () => {
          // Save current values before deleting
          fpBody.querySelectorAll("[data-ml]").forEach(inp => {
            const rid = inp.getAttribute("data-ml");
            const row = p.rows.find(r => r.id === rid);
            if (row) row.ml = clamp(num(inp.value, 0), 0, 100000);
          });
          const rid = btn.getAttribute("data-delrow");
          p.rows = p.rows.filter(r => r.id !== rid);
          renderEditor();
        };
      });

      $("p_cancel").onclick = () => {
        closeFullPage();
        render();
      };

      $("p_save").onclick = () => {
        const name = $("p_name").value.trim();
        if (!name) { alert("×—×•×‘×” ×©×"); return; }

        p.name = name;
        p.code = $("p_code").value.trim();
        if (!state.ui.hideInspired && $("p_insp")) p.inspiredBy = $("p_insp").value.trim();
        p.notes = $("p_notes").value.trim();
        p.date = $("p_date").value || todayISO();
        p.qtyMl = clamp(num($("p_qty").value, p.qtyMl), 0, 100000);
        p.updatedAt = todayISO();

        if (isFinal) {
          p.marketingText = $("p_mkt").value.trim();
          p.notesTop = $("p_top").value.trim();
          p.notesHeart = $("p_heart").value.trim();
          p.notesBase = $("p_base").value.trim();
        }

        // Clean rows without material
        p.rows = p.rows.filter(r => r.materialId && getMaterial(r.materialId));

        const list = getPerfumeList(mode);
        const idx = list.findIndex(x => x.id === p.id);
        if (idx >= 0) list[idx] = p;
        else list.unshift(p);
        setPerfumeList(mode, list);

        saveState();
        closeFullPage();
        render();
      };
    };

    openFullPage({
      title: isNew ? "×¤×•×¨××•×œ×” ×—×“×©×”" : "×¢×¨×™×›×ª ×¤×•×¨××•×œ×”",
      pill: isFinal ? "×¡×•×¤×™" : "×¤×™×ª×•×—",
      body: ""
    });
    renderEditor();
  };

  // ==================== SETTINGS PAGE ====================
  const renderSettings = () => {
    const left = $("leftPanel");
    const right = $("rightPanel");

    left.innerHTML = `
      <h2>âš™ï¸ ×”×’×“×¨×•×ª</h2>
      ${renderToggles()}
      <div class="hr"></div>
      <div class="small">
        <p><strong>×”×¡×‘×¨:</strong></p>
        <ul style="margin:10px 0;padding-right:20px">
          <li>"×§×•×“×™× ×œ×ª××¦×™×•×ª" - ××¦×™×’ ××¡×¤×¨×™× ×‘××§×•× ×©××•×ª</li>
          <li>"×”×¡×ª×¨ ×ª××¦×™×•×ª" - ××¡×ª×™×¨ ×§×˜×’×•×¨×™×” ×‘×ª×¦×•×’×”</li>
          <li>"××¦×‘ ×˜×›× ×™" - ××¦×™×’ ××–×”×¨×•×ª ×•×‘××’×™×</li>
          <li>"×”×©×œ× ×œ-100%" - ××•×¡×™×£ ××œ×›×•×”×•×œ ××•×˜×•××˜×™×ª</li>
        </ul>
      </div>
    `;

    right.innerHTML = `
      <h2>ğŸ”§ ×ª×—×–×•×§×”</h2>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <button class="btn" id="btnRepair">ğŸ”§ ×ª×™×§×•×Ÿ × ×ª×•× ×™×</button>
        <button class="btn danger" id="btnHardReset">ğŸ’£ ××™×¤×•×¡ ××œ×</button>
      </div>
      <div class="hr"></div>
      <div class="small">
        <p><strong>×¡×˜×˜×™×¡×˜×™×§×•×ª:</strong></p>
        <ul style="margin:10px 0;padding-right:20px">
          <li>×—×•××¨×™ ×’×œ×: ${state.materials.length}</li>
          <li>×¤×™×ª×•×—×™×: ${state.perfumesDev.length}</li>
          <li>×‘×©××™× ×¡×•×¤×™×™×: ${state.perfumesFinal.length}</li>
        </ul>
      </div>
    `;

    wireToggles(left);

    $("btnRepair").onclick = () => {
      // Ensure DPG exists
      if (!getDPG()) {
        state.materials.unshift({ id: "MAT_DPG", name: "DPG", code: "DPG", category: "×§×‘×•×¢×™×", desc: "Dipropylene Glycol", pricePerKg: null, pricePerMl: null, diluted: false, dilutionPercent: null });
      }
      // Clean invalid material references
      const ids = new Set(state.materials.map(m => m.id));
      const clean = (arr) => arr.map(p => ({ ...p, rows: (p.rows || []).filter(r => ids.has(r.materialId)) }));
      state.perfumesDev = clean(state.perfumesDev);
      state.perfumesFinal = clean(state.perfumesFinal);
      saveState();
      render();
      alert("×ª×™×§×•×Ÿ ×‘×•×¦×¢!");
    };

    $("btnHardReset").onclick = () => {
      if (!confirm("××™×¤×•×¡ ×™××—×§ ××ª ×›×œ ×”× ×ª×•× ×™×. ×‘×˜×•×—?")) return;
      if (!confirm("×‘×××ª ×‘×˜×•×—? ×–×” ×‘×œ×ª×™ ×”×¤×™×š!")) return;
      state = defaultState();
      saveState();
      render();
    };
  };

  // ==================== EXPORT/IMPORT ====================
  const exportJSON = () => {
    saveState();
    const out = JSON.parse(JSON.stringify(state));
    // Remove temp keys
    Object.keys(out).filter(k => k.startsWith("_")).forEach(k => delete out[k]);
    const blob = new Blob([JSON.stringify(out, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `enigma-backup-${todayISO()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  const importJSON = async (file) => {
    try {
      const text = await file.text();
      const incoming = JSON.parse(text);

      // Support single perfume insert
      if (incoming && incoming.kind === "enigma-dev-insert" && incoming.perfume) {
        const pp = incoming.perfume;
        const newPerf = {
          id: uid(),
          name: String(pp.name || "").trim() || "Unnamed",
          code: String(pp.code || "").trim(),
          inspiredBy: String(pp.inspiredBy || "").trim(),
          notes: String(pp.notes || "").trim(),
          date: todayISO(),
          updatedAt: todayISO(),
          qtyMl: clamp(num(pp.qtyMl, state.defaultQty), 0, 100000),
          rows: Array.isArray(pp.rows) ? pp.rows.map(r => ({
            id: uid(),
            materialId: String(r.materialId || "").trim(),
            ml: clamp(num(r.ml, 0), 0, 100000),
            catHint: r.catHint || r.category || null
          })) : [],
          marketingText: String(pp.marketingText || "").trim(),
          notesTop: String(pp.notesTop || "").trim(),
          notesHeart: String(pp.notesHeart || "").trim(),
          notesBase: String(pp.notesBase || "").trim()
        };

        // Create missing materials
        const existingIds = new Set(state.materials.map(m => m.id));
        newPerf.rows.forEach(r => {
          if (r.materialId && !existingIds.has(r.materialId)) {
            state.materials.unshift({
              id: r.materialId,
              name: `Imported (${r.materialId})`,
              code: "",
              category: CATEGORIES.includes(r.catHint) ? r.catHint : "×ª××¦×™×•×ª",
              desc: "× ×•×¦×¨ ××•×˜×•××˜×™×ª ×‘×™×™×‘×•×",
              pricePerKg: null,
              pricePerMl: null,
              diluted: false,
              dilutionPercent: null
            });
            existingIds.add(r.materialId);
          }
        });

        state.perfumesDev.unshift(newPerf);
        saveState();
        render();
        alert("×”×¤×•×¨××•×œ×” × ×•×¡×¤×” ×œ×¤×™×ª×•×—×™×!");
        return;
      }

      // Full backup restore
      if (!confirm("×œ×“×¨×•×¡ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™×?")) return;

      const next = defaultState();
      // Map old field names to new ones
      const incomingUI = incoming.ui || {};
      next.ui = {
        ...next.ui,
        tab: incomingUI.tab || "materials",
        showCodes: incomingUI.showCodes ?? incomingUI.showEssenceCodes ?? false,
        hideEssences: incomingUI.hideEssences ?? false,
        hideInspired: incomingUI.hideInspired ?? false,
        hidePrices: incomingUI.hidePrices ?? false,
        debugMode: incomingUI.debugMode ?? false,
        sortMaterials: incomingUI.sortMaterials || "new",
        sortDev: incomingUI.sortDev || "new",
        sortFinal: incomingUI.sortFinal || "new"
      };
      next.defaultQty = num(incoming.defaultQty ?? incoming._defaultQty, 50);

      if (Array.isArray(incoming.materials)) {
        next.materials = incoming.materials.map(m => ({
          id: String(m.id || uid()),
          name: String(m.name || "").trim() || "Unnamed",
          code: String(m.code || "").trim(),
          category: CATEGORIES.includes(m.category) ? m.category : "×ª××¦×™×•×ª",
          desc: String(m.desc || "").trim(),
          pricePerKg: (m.pricePerKg === null || m.pricePerKg === undefined || m.pricePerKg === "") ? null : num(m.pricePerKg),
          pricePerMl: (m.pricePerMl === null || m.pricePerMl === undefined || m.pricePerMl === "") ? null : num(m.pricePerMl),
          diluted: !!m.diluted,
          dilutionPercent: m.diluted ? clamp(num(m.dilutionPercent, 50), 0, 100) : null
        }));
      }

      // Ensure DPG exists
      if (!next.materials.find(m => m.id === "MAT_DPG")) {
        next.materials.unshift({ id: "MAT_DPG", name: "DPG", code: "DPG", category: "×§×‘×•×¢×™×", desc: "Dipropylene Glycol", pricePerKg: null, pricePerMl: null, diluted: false, dilutionPercent: null });
      }
      // Ensure Citrofol F exists
      if (!next.materials.find(m => m.id === "MAT_CIT")) {
        next.materials.unshift({ id: "MAT_CIT", name: "Citrofol F", code: "CIT", category: "×§×‘×•×¢×™×", desc: "Triethyl Citrate", pricePerKg: null, pricePerMl: null, diluted: false, dilutionPercent: null });
      }

      const ingestPerf = (arr) => (Array.isArray(arr) ? arr : []).map(p => ({
        id: p.id || uid(),
        name: String(p.name || "").trim() || "Unnamed",
        code: String(p.code || "").trim(),
        inspiredBy: String(p.inspiredBy || "").trim(),
        notes: String(p.notes || "").trim(),
        date: p.date || todayISO(),
        updatedAt: p.updatedAt || todayISO(),
        qtyMl: clamp(num(p.qtyMl, next.defaultQty), 0, 100000),
        rows: Array.isArray(p.rows) ? p.rows.map(r => ({
          id: r.id || uid(),
          materialId: String(r.materialId || "").trim(),
          ml: clamp(num(r.ml, 0), 0, 100000),
          catHint: r.catHint || null
        })) : [],
        marketingText: String(p.marketingText || "").trim(),
        notesTop: String(p.notesTop || "").trim(),
        notesHeart: String(p.notesHeart || "").trim(),
        notesBase: String(p.notesBase || "").trim()
      }));

      next.perfumesDev = ingestPerf(incoming.perfumesDev);
      next.perfumesFinal = ingestPerf(incoming.perfumesFinal);

      // Create missing materials referenced in perfumes
      const existingIds = new Set(next.materials.map(m => m.id));
      [...next.perfumesDev, ...next.perfumesFinal].forEach(p => {
        (p.rows || []).forEach(r => {
          if (r.materialId && !existingIds.has(r.materialId)) {
            next.materials.unshift({
              id: r.materialId,
              name: `Imported (${r.materialId})`,
              code: "",
              category: "×ª××¦×™×•×ª",
              desc: "× ×•×¦×¨ ××•×˜×•××˜×™×ª ×‘×™×™×‘×•×",
              pricePerKg: null,
              pricePerMl: null,
              diluted: false,
              dilutionPercent: null
            });
            existingIds.add(r.materialId);
          }
        });
      });

      state = next;
      saveState();
      render();
      alert("×™×™×‘×•× ×”×•×©×œ×!");
    } catch (e) {
      console.error(e);
      alert("×©×’×™××” ×‘×™×™×‘×•×: " + e.message);
    }
  };

  // ==================== TABS & RENDER ====================
  const tabs = $("tabs");
  tabs.querySelectorAll(".tab").forEach(t => {
    t.onclick = () => {
      state.ui.tab = t.getAttribute("data-tab");
      saveState();
      render();
    };
  });

  const setActiveTab = () => {
    tabs.querySelectorAll(".tab").forEach(t => {
      t.classList.toggle("active", t.getAttribute("data-tab") === state.ui.tab);
    });
  };

  const render = () => {
    setActiveTab();
    $("leftPanel").innerHTML = "";
    $("rightPanel").innerHTML = "";

    const tab = state.ui.tab;
    if (tab === "materials") renderMaterials();
    else if (tab === "dev") renderPerfumes("dev");
    else if (tab === "final") renderPerfumes("final");
    else if (tab === "pricing") renderPricing();
    else if (tab === "settings") renderSettings();
    else renderMaterials();
  };

  // ==================== INIT ====================
  $("btnExport").onclick = exportJSON;
  $("btnImport").onclick = () => $("importFile").click();
  $("importFile").onchange = async (e) => {
    const file = e.target.files && e.target.files[0];
    if (file) await importJSON(file);
    $("importFile").value = "";
  };
  $("btnSync").onclick = async () => {
    if (!firebaseReady) {
      alert("××ª×—×‘×¨ ×œ×¢× ×Ÿ...");
      await initFirebase();
      if (firebaseReady) {
        render();
        alert("âœ… ××—×•×‘×¨ ×œ×¢× ×Ÿ!\n×—×•××¨×™×: " + state.materials.length + "\n×¤×™×ª×•×—×™×: " + state.perfumesDev.length);
      } else {
        alert("âŒ ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ.\n×‘×“×•×§ ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜.");
      }
      return;
    }
    
    const choice = confirm("ğŸ”„ ×¡× ×›×¨×•×Ÿ ×¢× ×Ÿ\n\nOK = ×˜×¢×Ÿ ××”×¢× ×Ÿ (×™×—×œ×™×£ × ×ª×•× ×™× ××§×•××™×™×)\nCancel = ×©××•×¨ ×œ×¢× ×Ÿ (×™×—×œ×™×£ × ×ª×•× ×™× ×‘×¢× ×Ÿ)");
    if (choice) {
      const success = await loadFromCloud();
      render();
      if (success) {
        alert("âœ… × ×˜×¢×Ÿ ××”×¢× ×Ÿ!\n×—×•××¨×™×: " + state.materials.length + "\n×¤×™×ª×•×—×™×: " + state.perfumesDev.length);
      } else {
        alert("âŒ ×©×’×™××” ×‘×˜×¢×™× ×” ××”×¢× ×Ÿ");
      }
    } else {
      const success = await saveToCloud();
      if (success) {
        alert("âœ… × ×©××¨ ×œ×¢× ×Ÿ!");
      } else {
        alert("âŒ ×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ");
      }
    }
  };
  $("btnReset").onclick = () => {
    if (!confirm("××™×¤×•×¡ ×™××—×§ ×”×›×œ. ×‘×˜×•×—?")) return;
    state = defaultState();
    saveState();
    render();
  };

  // Initialize Firebase
  initFirebase().then(() => {
    render();
  });

  render();
})();
</script>
</body>
</html>
